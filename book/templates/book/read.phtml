{% extends 'master.phtml' %}
{% load i18n %}
{% load static_tags %}
{% block title %}{{chapter.book.title}} - {% trans 'Page'%} {{chapter.number}}{% endblock %}
{% load_css static /book/style.css %}
{% block content %}
<div class="row">
	<div class="col-lg-9">
		<h3>{{book.title}} / {{book.author.name}}</h3>
		<div class="panel panel-default">
        	<div class="panel-body">
				{% include 'book/_read_pagination.phtml'%}
				<div id="chapters">
					<div id="chapter" class="item chapter" item_id="{{chapter.id}}">
						<h2><span class="number">{{chapter.number}}</span> - {{chapter.title}}</h2>
						<div class="content">{{chapter.content|safe}}</div>
					</div>
				</div>
				{% include 'book/_read_pagination.phtml'%}
            </div>
        </div>
		<script>
		    var disqus_url = get_real_link("{% url 'book_read' chapter.book.slug %}");
		</script>
		{% include 'disqus.phtml'%}
	</div>
	<div class="col-lg-3 sidebar-margin-top">
		<div id="chapter-thank" class="panel panel-default">
			<div class="panel-heading">{% trans 'Cám ơn người đăng' %}</div>
			<div class="panel-body">
				<div class="thank-count">
					<button 
						class="
						btn thank-button
						{% if chapter.thanked_by_current_user %}btn-disable
						{% elif not user.is_authenticated %}btn-disable login_required
						{% else %}btn-default
						{% endif %}"
						title="{% if chapter.thanked_by_current_user %}{% trans 'Bạn đã gởi cám ơn' %}{% elif not user.is_authenticated %}{% trans 'Bạn cần đăng nhập để gởi cám ơn' %}{% else %}{% trans 'Gởi lời cám ơn tới người đăng chương truyện này' %}{% endif %}"
						>
						<span class="count">{{chapter.thank_count}}</span> {% trans "Cám ơn" %}
					</button>
				</div>
				<script type="text/javascript">
(function($){
	var thankButton = $("#chapter-thank .thank-button");
	var thankCountDiv = $("#chapter-thank .count");
	var thankCount = parseInt(thankCountDiv.text());
	function thank(event){
		thankButton
			.unbind('click', thank)
			.removeClass('btn-default')
			.addClass('btn-disable');
		var request = {};
		request['url'] = '{% url "summit_thank_request" %}';
		request['data'] = {};
		request['data']['chapter_id'] = '{{chapter.id}}';
		request['type'] = 'POST';
		request['success'] = function(data){
			console.log(data);
			thankButton.removeClass('loading');
		};
		thankButton.addClass('loading');
		$.ajax(request);

		thankCountDiv.html(thankCount + 1);
	}
	if(!thankButton.hasClass('btn-disable')){
		thankButton.click(thank)
	}
})(jQuery);
				</script>
				{% csrf_token %}
			</div>
		</div>
		<div class="panel panel-default favorite">
			<div class="panel-body">
				<button class="btn 
					{% if not user.is_authenticated %}
						btn-disable login_required
					{% else %}
						{% if chapter.book.favorited_by_current_user %}btn-disable{% else %}btn-default{% endif %}
					{% endif %}
					" id="favorite_book" 
					favorite="{% if chapter.book.favorited_by_current_user %}yes{% else %}no{% endif %}"
					{% if not user.is_authenticated %}title="{% trans 'Bạn cần đăng nhập để đánh dâu thích đọc' %}"{% endif %}>
					{% if chapter.book.favorited_by_current_user %}
						{% trans "Dừng thích đọc" %}
					{% else %}
						{% trans "Thích đọc" %}
					{% endif %}
				</button>
				<script>
(function($){
	var loading = false;
	$("#favorite_book").click(function(){
		if(loading){
			return;
		}
		loading = true;
		var request = {};
		request['url'] = '{% url "submit_favorite_book" %}';
		request['data'] = {'id' : '{{chapter.book.id}}'};
		request['type'] = 'POST';
		if($(this).attr('favorite') == 'no'){
			var ajaxComplete = function(){
				$("#favorite_book").attr('favorite', 'yes');
				$("#favorite_book").html('{% trans "Dừng thích đọc" %}');
			}
		} else {
			var ajaxComplete = function(){
				$("#favorite_book").attr('favorite', 'no');
				$("#favorite_book").html('{% trans "Thích đọc" %}');
			}
		};
		request['success'] = function(data){
			loading = false;
			$("#favorite_book").removeClass('loading');
			ajaxComplete();
		};
		$("#favorite_book").addClass('loading');
		$.ajax(request);
	});
})(jQuery);
				</script>
			</div>
		</div>
		<div class="panel panel-default rating" id="book_rating">
			<div class="panel-heading">{% trans 'Đánh giá truyện' %}</div>
			<div class="panel-body">
				<div class="result">
					Đánh giá <strong><span class="average-result">{{book.rating.average_result}}</span></strong> 
					qua <strong><span class="rating-count">{{book.rating.rating_count}}</span></strong> lượt
				</div>
				<div class="rate-star">
					{% for i in book.rating.rating_range %}
					<button class="btn btn-default rate-star-{{i}}" data-rate-number="{{i}}"
					{% if book.rated_by_current_user %}
						disabled='disabled'
					{% elif not user.is_authenticated %}
					disabled='disabled' class='login_required'
					{% endif %}>{{i}}</button>
					{% endfor %}
				</div>
				<script type="text/javascript">
(function($){
	$("#book_rating .rate-star button").click(function(){
		var clickedButton = this;
		rateNumber = $(this).data('rate-number');

		$("#book_rating .rate-star button").attr('disabled', true);
		resultSpan = $("#book_rating .average-result");
		countSpan = $("#book_rating .rating-count");

		ratingCount = parseInt(countSpan.html());

		var newResult = (ratingCount * parseFloat(resultSpan.html()) + rateNumber) / (ratingCount + 1);
		newResult = newResult.toFixed(2);

		resultSpan.html(newResult);
		countSpan.html(ratingCount + 1);

		request = {};
		request['url'] = '{% url "submit_book_rating" %}';
		request['type'] = 'POST';
		request['data'] = {};
		request['data']['number'] = rateNumber;
		request['data']['book_id'] = '{{book.id}}';
		request['success'] = function(data){
			resultSpan.html(data['average_result'].toFixed(2));
			countSpan.html(data['rating_count']);
			$(clicked_button).removeClass('loading');
		}
		$(clickedButton).addClass('loading');
		$.ajax(request);
	});
})(jQuery);
				</script>
			</div>
		</div>
		<div id="book" item_id="{{chapter.book.id}}" class="panel panel-default">
			<div class="panel-heading">{{book.title}}</div>
			<div class="panel-body">{{book.description}}</div>
		</div>
		<div id="author" author_id="{{book.author.id}}" class="panel panel-default">
			<div class="panel-heading">{{book.author.name}}</div>
			<div class="panel-body">{{book.author.information}}</div>
		</div>
	</div>
</div>
{% endblock %}